<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>To‑Do List</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <header class="app-header">
      <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M9 11l3 3L22 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>To‑Do</span>
      </div>
      <div class="auth">
        <button id="signin" class="btn">Sign in</button>
        <button id="signout" class="btn btn-ghost hidden">Sign out</button>
        <span id="user-info" class="user-info"></span>
      </div>
    </header>

    <main class="container">
      <section class="composer">
        <input id="new-title" type="text" placeholder="Add a new task…" maxlength="200" autocomplete="off" />
        <input id="new-due" type="date" />
        <button id="add" class="btn btn-primary">Add</button>
      </section>

      <section class="toolbar">
        <div class="filters" role="tablist" aria-label="Filters">
          <button class="chip active" data-filter="all">All</button>
          <button class="chip" data-filter="active">Active</button>
          <button class="chip" data-filter="completed">Completed</button>
        </div>
        <div class="tools">
          <input id="search" type="search" placeholder="Search" />
          <button id="clear-completed" class="btn btn-ghost">Clear completed</button>
        </div>
      </section>

      <ul id="list" class="list" aria-live="polite"></ul>

      <footer class="statusbar">
        <span id="count">0 items</span>
        <span id="sync-status" class="sync">Local</span>
      </footer>
    </main>

    <template id="item-template">
      <li class="item" data-id="">
        <label class="checkbox">
          <input type="checkbox" class="toggle" />
          <span class="checkmark" aria-hidden="true"></span>
        </label>
        <input type="text" class="title" />
        <input type="date" class="due" />
        <button class="icon-btn delete" title="Delete" aria-label="Delete">✕</button>
      </li>
    </template>

    <script>
      const dom = {
        list: document.getElementById('list'),
        newTitle: document.getElementById('new-title'),
        newDue: document.getElementById('new-due'),
        add: document.getElementById('add'),
        count: document.getElementById('count'),
        clearCompleted: document.getElementById('clear-completed'),
        filters: document.querySelectorAll('.chip'),
        search: document.getElementById('search'),
        syncStatus: document.getElementById('sync-status'),
        signin: document.getElementById('signin'),
        signout: document.getElementById('signout'),
        userInfo: document.getElementById('user-info')
      };

      let tasks = [];
      let filter = 'all';
      let searchQuery = '';
      let isFirebaseConfigured = false;
      let currentUser = null;

      async function apiCall(endpoint, method = 'GET', data = null) {
        const options = {
          method: method,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        };
        
        if (data && method !== 'GET') {
          const formData = new URLSearchParams();
          Object.keys(data).forEach(key => {
            if (data[key] !== null && data[key] !== undefined) {
              formData.append(key, data[key]);
            }
          });
          options.body = formData.toString();
        }
        
        const response = await fetch(`/api${endpoint}`, options);
        if (!response.ok) {
          throw new Error(`API call failed: ${response.status} ${response.statusText}`);
        }
        return response.json();
      }

      async function loadTasks() {
        try {
          tasks = await apiCall('/tasks');
          render();
          updateSyncStatus();
        } catch (error) {
          console.error('Failed to load tasks:', error);
          // Show error in UI
          dom.syncStatus.textContent = 'Error loading tasks';
        }
      }

      async function addTask(title, due) {
        try {
          const newTask = await apiCall('/tasks/add', 'POST', { title, due });
          await loadTasks();
          dom.newTitle.value = '';
          dom.newDue.value = '';
        } catch (error) {
          console.error('Failed to add task:', error);
          alert('Failed to add task. Please try again.');
        }
      }

      async function updateTask(id, patch) {
        try {
          const task = tasks.find(t => t.id === id);
          if (!task) return;
          
          await apiCall('/tasks/update', 'POST', {
            id: id,
            title: patch.title !== undefined ? patch.title : task.title,
            completed: patch.completed !== undefined ? patch.completed : task.completed,
            due: patch.due !== undefined ? patch.due : task.due
          });
          
          await loadTasks();
        } catch (error) {
          console.error('Failed to update task:', error);
          loadTasks();
        }
      }

      async function removeTask(id) {
        try {
          await apiCall('/tasks/delete', 'POST', { id });
          await loadTasks();
        } catch (error) {
          console.error('Failed to remove task:', error);
          alert('Failed to delete task. Please try again.');
        }
      }

      async function clearCompleted() {
        try {
          await apiCall('/tasks/clear', 'POST');
          await loadTasks();
        } catch (error) {
          console.error('Failed to clear completed tasks:', error);
          alert('Failed to clear completed tasks. Please try again.');
        }
      }

      async function updateSyncStatus() {
        try {
          const status = await apiCall('/status');
          dom.syncStatus.textContent = status.syncStatus || 'Server';
        } catch (error) {
          console.error('Failed to get sync status:', error);
          dom.syncStatus.textContent = 'Server (offline)';
        }
      }

      async function initializeFirebase() {
        const serviceAccountPath = prompt('Enter path to Firebase service account JSON file:');
        const userId = prompt('Enter your user ID:');
        
        if (!serviceAccountPath || !userId) {
          alert('Firebase initialization cancelled.');
          return;
        }
        
        try {
          const result = await apiCall('/firebase/init', 'POST', {
            serviceAccountPath,
            userId
          });
          
          if (result.success) {
            isFirebaseConfigured = true;
            currentUser = { uid: userId };
            
            dom.signin.classList.add('hidden');
            dom.signout.classList.remove('hidden');
            dom.userInfo.textContent = `User: ${userId}`;
            
            await loadTasks();
            alert('Firebase connected successfully!');
          } else {
            alert('Firebase initialization failed: ' + (result.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Firebase initialization failed:', error);
          alert('Firebase initialization failed. Please check the console for details.');
        }
      }

      function signOut() {
        isFirebaseConfigured = false;
        currentUser = null;
        
        dom.signin.classList.remove('hidden');
        dom.signout.classList.add('hidden');
        dom.userInfo.textContent = '';
        
        loadTasks();
      }

      function render() {
        dom.list.innerHTML = '';
        const filtered = tasks
          .filter(t => filter === 'all' || (filter === 'active' ? !t.completed : t.completed))
          .filter(t => t.title.toLowerCase().includes(searchQuery));

        for (const task of filtered) {
          const node = document.getElementById('item-template').content.firstElementChild.cloneNode(true);
          node.dataset.id = task.id;
          const toggle = node.querySelector('.toggle');
          const title = node.querySelector('.title');
          const due = node.querySelector('.due');
          const del = node.querySelector('.delete');

          toggle.checked = !!task.completed;
          title.value = task.title;
          if (task.due) { due.value = task.due.slice(0, 10); }

          toggle.addEventListener('change', () => updateTask(task.id, { completed: toggle.checked }));
          title.addEventListener('input', debounce(() => updateTask(task.id, { title: title.value }), 500));
          due.addEventListener('change', () => updateTask(task.id, { due: due.value || null }));
          del.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete this task?')) {
              removeTask(task.id);
            }
          });

          dom.list.appendChild(node);
        }
        
        const remaining = tasks.filter(t => !t.completed).length;
        const total = tasks.length;
        dom.count.textContent = `${remaining} of ${total} remaining`;
      }

      function addTaskFromInput() {
        const title = dom.newTitle.value.trim();
        const due = dom.newDue.value || null;
        if (!title) return;
        addTask(title, due);
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      function bindUI() {
        dom.add.addEventListener('click', addTaskFromInput);
        dom.newTitle.addEventListener('keydown', e => { if (e.key === 'Enter') addTaskFromInput(); });
        dom.clearCompleted.addEventListener('click', clearCompleted);
        
        dom.filters.forEach(btn => btn.addEventListener('click', () => {
          dom.filters.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          filter = btn.dataset.filter;
          render();
        }));
        
        dom.search.addEventListener('input', () => { 
          searchQuery = dom.search.value.toLowerCase(); 
          render(); 
        });

        dom.signin.addEventListener('click', initializeFirebase);
        dom.signout.addEventListener('click', signOut);
      }

      async function main() {
        bindUI();
        await loadTasks();
        
        setInterval(updateSyncStatus, 30000);
      }

      if (document.readyState === 'loading') {
        window.addEventListener('DOMContentLoaded', main);
      } else {
        main();
      }
    </script>
  </body>
  </html>


